#!/usr/bin/env node
const util=require("./utils"),path=require("path"),print=require("./print"),open=require("open"),fs=require("fs"),chalk=require("chalk"),CachePath=path.join(__dirname,"..",".cache/note");async function fetchSync(){fs.existsSync(CachePath)||await exports.RemoteFetch()}const WEBSITE_KEY="websit";exports.SyncConfig=async function(){var e,t,{ok:r,msg:n}=await util.GetConfig(WEBSITE_KEY);r||(print.Error(n),{ok:e,msg:t,data:r}=await util.Inquirer([{type:"input",message:"请输入git仓库托管地址",default:"https://gitee.com",name:"git_url"},{type:"input",message:"owner(作者)",name:"owner",default:"gjwork"},{type:"input",message:"name(项目名)",name:"name",default:"note"},{type:"input",message:"branch(分支)",name:"branch",default:"master"}]),e||(print.Error(t),process.exit(1)),{git_url:n,owner:e,name:t,branch:r}=r,{ok:t,msg:r}=await util.SetConfig({[WEBSITE_KEY]:`${n}:${e}/${t}#${r}`}),t||(print.Error(r),process.exit(1)))},exports.Clear=async function(){var{ok:e,msg:t}=await util.ClearConfig();e?print.Message(t):(print.Error(t),process.exit(1))},exports.RemoteFetch=async function(){var{ok:e,data:t,msg:r}=await util.GetConfig(WEBSITE_KEY);return e||(print.Error(r),process.exit(1)),util.DownloadTemplate(t,CachePath,!0)},exports.ShowAll=async function(){await fetchSync();const e=require(`${CachePath}/websit.js`);var t=(e||[]).map(e=>{const{keywords:t,url:r,description:n}=e||{};return`${n} [${(t||[]).join()}] ${chalk.green(r)}\n`});print.Messages(t)},exports.Open=async function(t){await fetchSync();var r=require(`${CachePath}/websit.js`);const n=[];for(let e=0;e<r.length;e++){const{keywords:i=[]}=r[e];i.includes(t)&&n.push(r[e])}var e,a=n.length;return 0===a?print.Error("关键词不存在"):1===a?open(n[0].url):void(1<a&&({ok:e,data:a}=await util.Inquirer([{type:"list",message:"链接",name:"url",choices:n.map(e=>e.url)}]),e&&open(a.url)))};